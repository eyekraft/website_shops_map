# Виджет отображения списка магазинов

## Каталоги и библиотеки

### lib

Здесь лежат внешние используемые библиотеки:

* [bootstrap-selector](https://developer.snapappointments.com/bootstrap-select/) - красивый селектор для бутстрапа.

* [jquery-autocomplete](https://jqueryui.com/autocomplete/) - автодополнение для полей ввода.

### src

Здесь лежат исходники:

* ``css`` - каскадные таблицы стилей:

    * [reflex.css](https://github.com/leejordan/reflex) - библиотека рефлекс для отображения адаптивного интерфейса.

    * ``shop_list_style.css`` - дополнительные стили.

* ``img`` - pltcm пока лежит только иконка для сниппета.

* ``js`` - файл shop_list_shippet со всей логикой отрисовки.

    * ``shop_list_editor.js`` - логика виджета **shopList** из режима редактора сайта.

## shop_list_snippet.js

Содержит виджет **shopList** и некоторые вспомогательные функции:

* **toRadians** - перевод градусов в радианы.

* **decimalAdjust** - десятичное округление.

* **makeIterator** - делает итератор для массива.

* **filterShops** - функция фильтраци списка магазинов по строке поиска.

* **filterShopsOnProperties** - функция фильтраци списка магазинов по набору свойств.

* **shopList**

	* **computeShopDistance** - вычисление дистанции между клиентом и магазином, 0 если нет координат клиента.

	* **getLatLng** - получение координат клиента (грубые координаты получаются из yandex-maps, затем уточняются, если пользователь разрешает использовать геолокацию).

	* **getClientAddress** - по координатам клиента получаем его адрес человеческим языком через ymaps api.

	* **findShopById** - находим магазин по id.

	* **removePlacemarks** - удаляет все отметки с карты.

	* **loadSettings** - загружаем все настройки для получения списка магазинов.

	* **loadShopList** - загружаем список магазинов, так как рендер мы начинаем только после того, как получен весь список магазинов, а источников магазинов может быть много - создаем рекурсивную очередь promise, пробегаясь итератором по доступному списку настроек, как только все магазины получены (вся очередь промисов зарезолвилась) - резволвится результирующий промис.

	* **renderShopList** - рендерим список магазинов.

	* **renderClientAddress** - рендерим адрес клиента, адрес клиента дополнен полем для редактирования с автокомплитом на основе данных из геокодера yandex, запросы к геокодеру начинают уходить когда длина запроса превышает 8 букв.

	* **renderVerticalShopList** - рендер списка магазинов на вкладке с картой.

	* **renderBigMap** - рендер карты на вкладке с картой.

	* **renderClientPlacemark** - помещаем на карту отметку с положением клиента.

	* **renderRoute** - рисует на карте маршрут.

	* **renderPropertiesSelector** - рендер селектора свойств магазинов.

	* **init** - вызывает необходимые рендеры и привязывает обработчики событий к элементам интерфейса.
