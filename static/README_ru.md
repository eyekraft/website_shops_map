# Виджет отображения списка магазинов

## Каталоги и библиотеки

### lib

Здесь лежат внешние используемые библиотеки:

* [bootstrap-selector](https://developer.snapappointments.com/bootstrap-select/) - красивый селектор для бутстрапа.

* [jquery-autocomplete](https://jqueryui.com/autocomplete/) - автодополнение для полей ввода.

### src

Здесь лежат исходники:

* ``css`` - каскадные таблицы стилей:

    * [reflex.css](https://github.com/leejordan/reflex) - библиотека рефлекс для отображения адаптивного интерфейса.

    * ``shop_list_style.css`` - дополнительные стили.

* ``img`` - pltcm пока лежит только иконка для сниппета.

* ``js`` - файл shop_list_shippet со всей логикой отрисовки.

## shop_list_snippet.js

Содержит виджет shopList и некоторые вспомогательные функции:

* **toRadians** - перевод градусов в радианы.

* **decimalAdjust** - десятичное округление.

* **makeIterator** - делает итератор для массива.

* **filter_shops** - функция фильтраци списка магазинов по строке поиска.

* **filter_shops_on_properties** - функция фильтраци списка магазинов по набору свойств.

* **shopList**

	* **compute_shop_distance** - вычисление дистанции между клиентом и магазином, 0 если нет координат клиента.

	* **get_lat_lng** - получение координат клиента (грубые координаты получаются из yandex-maps, затем уточняются, если пользователь разрешает использовать геолокацию).

	* **get_client_address** - по координатам клиента получаем его адрес человеческим языком через ymaps api.

	* **find_shop_by_id** - находим магазин по id.

	* **remove_placemarks** - удаляет все отметки с карты.

	* **load_settings** - загружаем все настройки для получения списка магазинов.

	* **load_shop_list** - загружаем список магазинов, так как рендер мы начинаем только после того, как получен весь список магазинов, а источников магазинов может быть много - создаем рекурсивную очередь promise, пробегаясь итератором по доступному списку настроек, как только все магазины получены (вся очередь промисов зарезолвилась) - резволвится результирующий промис.

	* **render_shoplist** - рендерим список магазинов.

	* **render_client_address** - рендерим адрес клиента, адрес клиента дополнен полем для редактирования с автокомплитом на основе данных из геокодера yandex, запросы к геокодеру начинают уходить когда длина запроса превышает 8 букв.

	* **render_vertical_shoplist** - рендер списка магазинов на вкладке с картой.

	* **render_big_map** - рендер карты на вкладке с картой.

	* **render_client_placemark** - помещаем на карту отметку с положением клиента.

	* **render_route** - рисует на карте маршрут.

	* **render_properties_selector** - рендер селектора свойств магазинов.

	* **init** - вызывает необходимые рендеры и привязывает обработчики событий к элементам интерфейса.
